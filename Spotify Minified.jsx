#target "illustrator"
#include 'json2.min.js'

var spotifyUrl,track_id,codeUUID,songName,artistName,uuidList=[];function main(){track_id=getTrackIdFromSpotifyUrl(spotifyUrl=prompt("Enter spotify URL:",""));var e=new File(Folder.desktop+"/spotify.jar");if(!e.exists)for(run("wget -O %UserProfile%\\Desktop\\spotify.jar https://github.com/lewiswhitaker1/SpotifyAutomation-JSX/raw/main/jar/spotify.jar",!1);!e.exists;)$.sleep(1e3);run("java -jar %userprofile%\\Desktop\\spotify.jar "+spotifyUrl,!1)}function spotifyCode(){for(var e=new File(Folder.desktop+"/spotify/"+track_id+"/scannable.svg");!e.exists;)$.sleep(1e3);app.open(e)}function createSpotColor(){var e=app.activeDocument,t=new CMYKColor;t.cyan=100,t.magenta=0,t.yellow=0,t.black=0;var o=e.spots.add();o.color=t,o.colorType=ColorModel.SPOT,o.name="Spot1"}function spotifyCodeSize(){var e,t=new Window("dialog","Size Selection"),o=t.add("button",void 0,"Small"),r=t.add("button",void 0,"Medium"),a=t.add("button",void 0,"Large"),i=app.activeDocument,n=app.documents.getByName("Spotify.ai");o.onClick=function(){e="Small",t.close()},r.onClick=function(){e="Medium",t.close(),$.writeln(e)},a.onClick=function(){e="Large",t.close(),$.writeln(e)},t.show();var s=new Date().getTime();"Small"==e?resizeCode(38.922,6.487):"Medium"==e?resizeCode(58.382,9.73):"Large"==e&&resizeCode(77.843,12.974),findGroup(codeUUID),app.copy(),n.activate(),app.paste(),i.close(SaveOptions.DONOTSAVECHANGES);var p=n.groupItems.getByName(e).duplicate();p.name=e+s,app.coordinateSystem=CoordinateSystem.ARTBOARDCOORDINATESYSTEM;var c=n.artboards.getActiveArtboardIndex(),m=n.artboards[c].artboardRect;p.position=[(m[2]-m[0])/2-p.width/2,(m[3]-m[1])/2+p.height/2];var d=p.groupItems.getByName(e+" Code"),l=n.selection[0];templateCodePos=d.position,l.position=templateCodePos,l.move(p,ElementPlacement.PLACEATEND),d.remove(),spotifyInfo(p,e)}function spotifyInfo(e,t){fillInfo(track_id);var o=new Window("dialog","Photo Select"),r=o.add("button",void 0,"Album Cover"),a=o.add("button",void 0,"Personalised Photo");if(r.onClick=function(){choiceTwo="album",o.close()},a.onClick=function(){choiceTwo="perso";var e=new File(Folder.desktop+"/cropper.jar");if(!e.exists)for(run("wget -O %UserProfile%\\Desktop\\cropper.jar https://github.com/lewiswhitaker1/SpotifyAutomation-JSX/raw/main/jar/cropper.jar",!1);!e.exists;)$.sleep(1e3);o.close()},o.show(),"perso"==choiceTwo){var i,n=app.documents.getByName("Spotify.ai");run('java -jar %UserProfile%\\Desktop\\cropper.jar "'+File.openDialog("Select a personalised photo to open","*.*").fsName+'"',!1);for(var s=new File(File.decode(Folder.desktop+"/cropped.png"));!s.exists;)$.sleep(1e3);var p=create_UUID();pushToList(p),s.rename(Folder.desktop.absoluteURI+"/"+p+".png");var c=n.placedItems.add();c.file=s;var m=e.pathItems.getByName(t+" Picture"),d=m.position,l=m.geometricBounds;c.width=l[2]-l[0],c.height=l[2]-l[0],c.position=d,c.zOrder(ZOrderMethod.SENDTOBACK),c.move(e,ElementPlacement.PLACEATEND)}if("album"==choiceTwo){var n=app.documents.getByName("Spotify.ai"),s=new File(Folder.desktop+"/spotify/"+track_id+"/image.png"),c=n.placedItems.add();c.file=s;var m=e.pathItems.getByName(t+" Picture"),d=m.position,l=m.geometricBounds;c.width=l[2]-l[0],c.height=l[2]-l[0],c.position=d,c.zOrder(ZOrderMethod.SENDTOBACK),c.move(e,ElementPlacement.PLACEATEND)}bugGroup(),setNamesAndMove(e,t)}function create_UUID(){var e=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?o:3&o|8).toString(16)})}function getTrackIdFromSpotifyUrl(e){return e.substring(e.lastIndexOf("/")+1,e.indexOf("?"))}function run(e,t){var o=new File(Folder.temp.fsName+"/temp.bat");o.open("w"),t?(o.writeln("@echo off"),o.writeln(e),o.writeln("@pause")):o.writeln(e),o.close(),o.execute()}function resizeCode(e,t){var o=app.activeDocument,r=app.activeDocument.activeLayer.pathItems;r.length>0&&r[r.length-1].remove();var a=o.layers.getByName("Layer 1"),i=[],n=[];function s(e){if("PathItem"==e.typename)i.push(e);else if("CompoundPathItem"==e.typename)n.push(e);else if("GroupItem"==e.typename)for(var t=0;t<e.pageItems.length;t++)s(e.pageItems[t])}for(var p=0;p<a.pageItems.length;p++)s(a.pageItems[p]);for(var c=a.groupItems.add(),p=0;p<i.length;p++)i[p].moveToBeginning(c);for(var p=0;p<n.length;p++)n[p].moveToBeginning(c);c.width=e/25.4*72,c.height=t/25.4*72;for(var p=0;p<c.pageItems.length;p++){var m=c.pageItems[p];if("PathItem"==m.typename){var d=new SpotColor;d.spot=app.activeDocument.spots.getByName("Spot1"),m.fillColor=d}else if("CompoundPathItem"==m.typename)for(var l=0;l<m.pathItems.length;l++){var f=m.pathItems[l],d=new SpotColor;d.spot=app.activeDocument.spots.getByName("Spot1"),f.fillColor=d}}codeUUID=create_UUID(),c.name=codeUUID}function findGroup(e){for(var t=app.activeDocument.groupItems,o=0;o<t.length;o++){var r=t[o];if(r.name==e){r.selected=!0;break}}}function fillInfo(e){var t=Folder.desktop+"/spotify/"+e+"/data.json",o=new File(t);o.open("r");var r=o.read();o.close();var a=JSON.parse(r);artistName=a.creator,songName=a.title}function setNamesAndMove(e,t){for(var o=e.name,r=app.activeDocument,a=0;a<r.artboards.length;a++){r.artboards.setActiveArtboardIndex(a);for(var i=0;i<r.groupItems.length;i++){var n=r.groupItems[i];if(n.name===o)for(var s=0;s<n.textFrames.length;s++){var p=n.textFrames[s];-1!==p.contents.indexOf("Song Name")&&(p.contents=songName)}}}for(var a=0;a<r.artboards.length;a++){r.artboards.setActiveArtboardIndex(a);for(var i=0;i<r.groupItems.length;i++){var n=r.groupItems[i];if(n.name===o)for(var s=0;s<n.textFrames.length;s++){var p=n.textFrames[s];-1!==p.contents.indexOf("Artist Name")&&(p.contents=artistName)}}}e.transform(app.getScaleMatrix(-100,100));for(var c=!1,a=0;a<r.layers.length;a++)if("Artwork"==r.layers[a].name){c=!0;break}if(!c){var m=r.layers.add();m.name="Artwork",e.move(m,ElementPlacement.PLACEATEND);var d=10,l=2.8346*d,f=r.artboards[0],u=f.artboardRect,g=u[0]+l,v=u[1]-l;e.position=[g,v]}if(c){for(var h,m=r.layers.getByName("Artwork"),a=0;a<m.groupItems.length;a++){var n=m.groupItems[a];(!h||n.position[1]>h.position[1])&&(h=n)}e.move(m,ElementPlacement.PLACEATEND);var y=h.top-e.top;e.top+=y;for(var d=10,l=2.8346*d,f=r.artboards[0],x=m.groupItems,d=10,l=2.8346*d,I=f.artboardRect[0]+l,w=f.artboardRect[1]-l,a=0;a<x.length;a++){var n=x[a];I+n.width>f.artboardRect[2]&&(I=f.artboardRect[0]+l,w+=n.height-2*n.height-l),n.left=I,n.top=w,I+=n.width+l}}}function pushToList(e){try{var t=new File(Folder.desktop+"/photoNames.json");t.open("r");var o=t.read();t.close()}catch(r){alert("An error occurred while opening the file: "+r)}try{uuidList=JSON.parse(o)}catch(a){uuidList=[]}uuidList.push(e+".png");try{t.open("w"),t.write(JSON.stringify(uuidList)),t.close()}catch(i){alert("An error occurred while writing to the file: "+i)}}function bugGroup(){for(var e=app.activeDocument,t=0;t<e.groupItems.length;t++)""==e.groupItems[t].name&&e.groupItems[t].remove()}main(),spotifyCode(),createSpotColor(),spotifyCodeSize();