#target 'illustrator'
#include 'json2.min.js'

var url,choice;function partOne(){var e,t,o=new Window("dialog","Code Type"),r=o.add("button",void 0,"Song"),n=o.add("button",void 0,"Album"),a=o.add("button",void 0,"Playlist"),s=o.add("button",void 0,"Podcast");r.onClick=function(){e=prompt("Enter spotify URL:",""),choice="song",url=e,o.close()},n.onClick=function(){e=prompt("Enter spotify URL:",""),choice="album",url=e,o.close()},a.onClick=function(){e=prompt("Enter spotify URL:",""),choice="playlist",url=e,o.close()},s.onClick=function(){e=prompt("Enter spotify URL:",""),choice="podcast",url=e,o.close()},o.show();s=e.lastIndexOf("/"),s=e.substring(s+1);"song"==choice&&(t="https://scannables.scdn.co/uri/plain/svg/FFFFFF/black/1000/spotify:track:"+s),"playlist"==choice&&(t="https://scannables.scdn.co/uri/plain/svg/FFFFFF/black/1000/spotify:playlist:"+s),"album"==choice&&(t="https://scannables.scdn.co/uri/plain/svg/FFFFFF/black/1000/spotify:album:"+s),"podcast"==choice&&(t="https://scannables.scdn.co/uri/plain/svg/FFFFFF/black/1000/spotify:show:"+s),run("wget -O %UserProfile%\\Desktop\\spotify.svg "+t);for(var i=new File(File.decode(Folder.desktop+"/spotify.svg"));!i.exists;)$.sleep(1e3);app.open(i)}function partTwo(){var e=app.activeDocument,t=new CMYKColor;t.cyan=100,t.magenta=0,t.yellow=0,t.black=0;e=e.spots.add();e.color=t,e.colorType=ColorModel.SPOT,e.name="Spot1"}function partThree(){var r,e=new Window("dialog","Size Selection"),t=e.add("button",void 0,"Small"),o=e.add("button",void 0,"Medium"),n=e.add("button",void 0,"Large"),a=app.activeDocument,s=app.documents.getByName("Spotify.ai");t.onClick=function(){r="Small",e.close()},o.onClick=function(){r="Medium",e.close(),$.writeln(r)},n.onClick=function(){r="Large",e.close(),$.writeln(r)},e.show();o=app.activeDocument.activeLayer.pathItems;0<o.length&&o[o.length-1].remove();n=(new Date).getTime();app.doScript("Import (SHIFT + F3)","Spotify"),"Small"==r?app.doScript("Small (SHIFT + F6)","Spotify"):"Medium"==r?app.doScript("Medium (SHIFT + F5)","Spotify"):"Large"==r&&app.doScript("Large (SHIFT + F4)","Spotify"),app.copy(),s.activate(),app.paste(),a.close(SaveOptions.DONOTSAVECHANGES);var i=(B=s.groupItems.getByName(r)).duplicate();i.name=r+n,app.coordinateSystem=CoordinateSystem.ARTBOARDCOORDINATESYSTEM;o=s.artboards.getActiveArtboardIndex(),a=s.artboards[o].artboardRect;i.position=new Array((a[2]-a[0])/2-i.width/2,(a[3]-a[1])/2+i.height/2);var p,o=i.groupItems.getByName(r+" Code"),a=s.selection[0];templateCodePos=o.position,a.position=templateCodePos,a.move(i,ElementPlacement.PLACEATEND),o.remove();var c,l,d,m,f,u,F,v,y=new Window("dialog","Photo Select"),a=y.add("button",void 0,"Album Cover"),o=y.add("button",void 0,"Personalised Photo");if(a.onClick=function(){p="album",y.close()},o.onClick=function(){p="perso";var e=File.openDialog("Select a personalised photo to open","*.*"),t=s.placedItems.add();t.file=e;var o=i.pathItems.getByName(r+" Picture"),e=o.position;o.geometricBounds;t.position=e,t.zOrder(ZOrderMethod.SENDTOBACK),t.move(i,ElementPlacement.PLACEATEND),y.close()},y.show(),"album"==p){var h=url;run("wget -O %UserProfile%\\Desktop\\spotify.json "+("https://open.spotify.com/oembed?url="+h));for(var k=new File(File.decode(Folder.desktop+"/spotify.json"));!k.exists;)$.sleep(1e3);k.open("r");a=k.read();k.close();var w,o=(w=JSON.parse(a)).thumbnail_url;run("wget -O %UserProfile%\\Desktop\\"+(n=create_UUID())+".pdf "+o);var g=[];try{var T=new File(Folder.desktop+"/pdfNames.json");T.open("r");var x=T.read();T.close()}catch(e){alert("An error occurred while opening the file: "+e)}try{g=JSON.parse(x)}catch(e){g=[]}g.push(n+".pdf");try{T.open("w"),T.write(JSON.stringify(g)),T.close()}catch(e){alert("An error occurred while writing to the file: "+e)}for(var b=new File(File.decode(Folder.desktop+"/"+n+".pdf"));!b.exists;)$.sleep(1e3);a=s.placedItems.add();a.file=b;o=i.pathItems.getByName(r+" Picture"),n=o.position,o=o.geometricBounds;a.width=o[2]-o[0],a.height=o[2]-o[0],a.position=n,a.zOrder(ZOrderMethod.SENDTOBACK),a.move(i,ElementPlacement.PLACEATEND),k.remove()}if("album"==p){"song"==choice&&((c=new File(Folder.desktop+"/AUTH.bat")).open("w"),c.write("@echo off\n"),c.write('powershell -Command "$encoded=[convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes(\\"630362daba20469cb86bd75228f7e237:aeef6fa8de86452fa82b543f034d4858\\"));$response=curl.exe -X \\"POST\\" -H \\"Authorization: Basic $encoded\\" -d grant_type=client_credentials https://accounts.spotify.com/api/token;$key=($response | ConvertFrom-Json).access_token;$key" > %userprofile%\\Desktop\\key.txt'),c.close(),c.execute(),l=new File(Folder.desktop+"/key.txt"),$.sleep(1e3),l.open("r"),d=l.read(),l.close(),m=getTrackIdFromSpotifyUrl(h),(f=new File(Folder.desktop+"/TRACK_JSON.bat")).open("w"),f.write("set TRACKID="+m+"\n"),f.write("set AUTHTOKEN="+d+"\n"),f.write('curl.exe -X "GET" "https://api.spotify.com/v1/tracks/%TRACKID%" -H "Accept: application/json" -H "Content-Type: application/json" -H "Authorization: Bearer %AUTHTOKEN%" > %userprofile%\\Desktop\\track.json\n'),f.close(),f.execute(),$.sleep(5e3),c.remove(),l.remove(),f.remove(),(I=File("~/Desktop/track.json")).open("r"),v=I.read(),I.close(),u=(w=JSON.parse(v)).album.artists[0].name,F=w.name,I.remove()),"playlist"==choice&&((c=new File(Folder.desktop+"/AUTH.bat")).open("w"),c.write("@echo off\n"),c.write('powershell -Command "$encoded=[convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes(\\"630362daba20469cb86bd75228f7e237:aeef6fa8de86452fa82b543f034d4858\\"));$response=curl.exe -X \\"POST\\" -H \\"Authorization: Basic $encoded\\" -d grant_type=client_credentials https://accounts.spotify.com/api/token;$key=($response | ConvertFrom-Json).access_token;$key" > %userprofile%\\Desktop\\key.txt'),c.close(),c.execute(),l=new File(Folder.desktop+"/key.txt"),$.sleep(1e3),l.open("r"),d=l.read(),l.close(),m=getTrackIdFromSpotifyUrl(h),(f=new File(Folder.desktop+"/TRACK_JSON.bat")).open("w"),f.write("set TRACKID="+m+"\n"),f.write("set AUTHTOKEN="+d+"\n"),f.write('curl.exe -X "GET" "https://api.spotify.com/v1/playlists/%TRACKID%" -H "Accept: application/json" -H "Content-Type: application/json" -H "Authorization: Bearer %AUTHTOKEN%" > %userprofile%\\Desktop\\track.json\n'),f.close(),f.execute(),$.sleep(5e3),c.remove(),l.remove(),f.remove(),(I=File("~/Desktop/track.json")).open("r"),v=I.read(),I.close(),u=(w=JSON.parse(v)).owner.display_name,F=w.name,I.remove()),"album"==choice&&((c=new File(Folder.desktop+"/AUTH.bat")).open("w"),c.write("@echo off\n"),c.write('powershell -Command "$encoded=[convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes(\\"630362daba20469cb86bd75228f7e237:aeef6fa8de86452fa82b543f034d4858\\"));$response=curl.exe -X \\"POST\\" -H \\"Authorization: Basic $encoded\\" -d grant_type=client_credentials https://accounts.spotify.com/api/token;$key=($response | ConvertFrom-Json).access_token;$key" > %userprofile%\\Desktop\\key.txt'),c.close(),c.execute(),l=new File(Folder.desktop+"/key.txt"),$.sleep(1e3),l.open("r"),d=l.read(),l.close(),m=getTrackIdFromSpotifyUrl(h),(f=new File(Folder.desktop+"/TRACK_JSON.bat")).open("w"),f.write("set TRACKID="+m+"\n"),f.write("set AUTHTOKEN="+d+"\n"),f.write('curl.exe -X "GET" "https://api.spotify.com/v1/albums/%TRACKID%" -H "Accept: application/json" -H "Content-Type: application/json" -H "Authorization: Bearer %AUTHTOKEN%" > %userprofile%\\Desktop\\track.json\n'),f.close(),f.execute(),$.sleep(5e3),c.remove(),l.remove(),f.remove(),(I=File("~/Desktop/track.json")).open("r"),v=I.read(),I.close(),u=(w=JSON.parse(v)).artists[0].name,F=w.name,I.remove()),"podcast"==choice?((c=new File(Folder.desktop+"/AUTH.bat")).open("w"),c.write("@echo off\n"),c.write('powershell -Command "$encoded=[convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes(\\"630362daba20469cb86bd75228f7e237:aeef6fa8de86452fa82b543f034d4858\\"));$response=curl.exe -X \\"POST\\" -H \\"Authorization: Basic $encoded\\" -d grant_type=client_credentials https://accounts.spotify.com/api/token;$key=($response | ConvertFrom-Json).access_token;$key" > %userprofile%\\Desktop\\key.txt'),c.close(),c.execute(),l=new File(Folder.desktop+"/key.txt"),$.sleep(1e3),l.open("r"),d=l.read(),l.close(),m=getTrackIdFromSpotifyUrl(h),(f=new File(Folder.desktop+"/TRACK_JSON.bat")).open("w"),f.write("set TRACKID="+m+"\n"),f.write("set AUTHTOKEN="+d+"\n"),f.write('curl.exe -X "GET" "https://api.spotify.com/v1/shows/%TRACKID%?market=GB" -H "Accept: application/json" -H "Content-Type: application/json" -H "Authorization: Bearer %AUTHTOKEN%" > %userprofile%\\Desktop\\track.json\n'),f.close(),f.execute(),$.sleep(5e3),c.remove(),l.remove(),f.remove(),(I=File("~/Desktop/track.json")).open("r"),v=I.read(),I.close(),u="",F=(w=JSON.parse(v)).name,alert(m),alert(F),I.remove()):(F=prompt("Enter song name:",""),u=prompt("Enter artist name:",""));for(var A=i.name,S=app.activeDocument,C=0;C<S.artboards.length;C++){S.artboards.setActiveArtboardIndex(C);for(var O=0;O<S.groupItems.length;O++)if((B=S.groupItems[O]).name===A)for(var E=0;E<B.textFrames.length;E++)-1!==(D=B.textFrames[E]).contents.indexOf("Song Name")&&(D.contents=F)}for(C=0;C<S.artboards.length;C++){S.artboards.setActiveArtboardIndex(C);for(O=0;O<S.groupItems.length;O++)if((B=S.groupItems[O]).name===A)for(var D,E=0;E<B.textFrames.length;E++)-1!==(D=B.textFrames[E]).contents.indexOf("Artist Name")&&(D.contents=u)}i.transform(app.getScaleMatrix(-100,100));for(var I,N=!1,C=0;C<S.layers.length;C++)if("Artwork"==S.layers[C].name){N=!0;break}if(N||((U=S.layers.add()).name="Artwork",i.move(U,ElementPlacement.PLACEATEND),R=2.8346*5,I=(P=(K=S.artboards[0]).artboardRect)[0]+R,P=P[1]-R,i.position=[I,P]),N){for(var H,U=S.layers.getByName("Artwork"),C=0;C<U.groupItems.length;C++){var B=U.groupItems[C];(!H||B.position[1]>H.position[1])&&(H=B)}i.move(U,ElementPlacement.PLACEATEND);var P=H.top-i.top;i.top+=P;for(var R=2.8346*10,K=S.artboards[0],_=U.groupItems,R=2.8346*10,j=K.artboardRect[0]+R,J=K.artboardRect[1]-R,C=0;C<_.length;C++)j+(B=_[C]).width>K.artboardRect[2]&&(j=K.artboardRect[0]+R,J+=B.height-2*B.height-R),B.left=j,B.top=J,j+=B.width+R}(k=new File(File.decode(Folder.desktop+"/spotify.svg"))).remove()}}function create_UUID(){var o=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(o+16*Math.random())%16|0;return o=Math.floor(o/16),("x"==e?t:3&t|8).toString(16)})}function getTrackIdFromSpotifyUrl(e){return e.substring(e.lastIndexOf("/")+1,e.indexOf("?"))}function run(e){var t=new File(Folder.temp.fsName+"/temp.bat");t.open("w"),t.writeln(e),t.close(),t.execute()}partOne(),$.sleep(1e3),partTwo(),$.sleep(1e3),partThree();
