#target "illustrator"
#include 'json2.min.js'

var spotifyUrl,track_id,codeUUID,songName,artistName,uuidList=[];function main(){track_id=getTrackIdFromSpotifyUrl(spotifyUrl=prompt("Enter spotify URL:","")),run("wget -O %UserProfile%\\Desktop\\spotify.jar https://github.com/lewiswhitaker1/SpotifyAutomation-JSX/raw/main/jar/spotify.jar",!1);for(var e=new File(Folder.desktop+"/spotify.jar");!e.exists;)$.sleep(1e3);run("java -jar %userprofile%\\Desktop\\spotify.jar "+spotifyUrl,!1)}function spotifyCode(){for(var e=new File(Folder.desktop+"/spotify/"+track_id+"/scannable.svg");!e.exists;)$.sleep(1e3);app.open(e)}function createSpotColor(){var e=app.activeDocument,t=new CMYKColor;t.cyan=100,t.magenta=0,t.yellow=0,t.black=0;var o=e.spots.add();o.color=t,o.colorType=ColorModel.SPOT,o.name="Spot1"}function spotifyCodeSize(){var e,t=new Window("dialog","Size Selection"),o=t.add("button",void 0,"Small"),r=t.add("button",void 0,"Medium"),a=t.add("button",void 0,"Large"),i=app.activeDocument,n=app.documents.getByName("Spotify.ai");o.onClick=function(){e="Small",t.close()},r.onClick=function(){e="Medium",t.close(),$.writeln(e)},a.onClick=function(){e="Large",t.close(),$.writeln(e)},t.show();var s=(new Date).getTime();"Small"==e?resizeCode(38.922,6.487):"Medium"==e?resizeCode(58.382,9.73):"Large"==e&&resizeCode(77.843,12.974),findGroup(codeUUID),app.copy(),n.activate(),app.paste(),i.close(SaveOptions.DONOTSAVECHANGES);var p=n.groupItems.getByName(e).duplicate();p.name=e+s,app.coordinateSystem=CoordinateSystem.ARTBOARDCOORDINATESYSTEM;var l=n.artboards.getActiveArtboardIndex(),d=n.artboards[l].artboardRect;p.position=[(d[2]-d[0])/2-p.width/2,(d[3]-d[1])/2+p.height/2];var c=p.groupItems.getByName(e+" Code"),m=n.selection[0];templateCodePos=c.position,m.position=templateCodePos,m.move(p,ElementPlacement.PLACEATEND),c.remove(),spotifyInfo(p,e)}function spotifyInfo(e,t){fillInfo(track_id);var o=new Window("dialog","Photo Select"),r=o.add("button",void 0,"Album Cover"),a=o.add("button",void 0,"Personalised Photo");if(r.onClick=function(){choiceTwo="album",o.close()},a.onClick=function(){choiceTwo="perso",run("wget -O %UserProfile%\\Desktop\\cropper.jar https://github.com/lewiswhitaker1/SpotifyAutomation-JSX/raw/main/jar/cropper.jar",!1);for(var e=new File(Folder.desktop+"/cropper.jar");!e.exists;)$.sleep(1e3);o.close()},o.show(),"perso"==choiceTwo){var i=app.documents.getByName("Spotify.ai");run('java -jar %UserProfile%\\Desktop\\cropper.jar "'+File.openDialog("Select a personalised photo to open","*.*").fsName+'"',!1);for(var n=new File(File.decode(Folder.desktop+"/cropped.png"));!n.exists;)$.sleep(1e3);var s=create_UUID();pushToList(s),n.rename(Folder.desktop.absoluteURI+"/"+s+".png"),(d=i.placedItems.add()).file=n;var p=(c=e.pathItems.getByName(t+" Picture")).position,l=c.geometricBounds;d.width=l[2]-l[0],d.height=l[2]-l[0],d.position=p,d.zOrder(ZOrderMethod.SENDTOBACK),d.move(e,ElementPlacement.PLACEATEND)}if("album"==choiceTwo){var d;i=app.documents.getByName("Spotify.ai"),n=new File(Folder.desktop+"/spotify/"+track_id+"/image.png");(d=i.placedItems.add()).file=n;var c;p=(c=e.pathItems.getByName(t+" Picture")).position,l=c.geometricBounds;d.width=l[2]-l[0],d.height=l[2]-l[0],d.position=p,d.zOrder(ZOrderMethod.SENDTOBACK),d.move(e,ElementPlacement.PLACEATEND)}setNamesAndMove(e,t)}function create_UUID(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?o:3&o|8).toString(16)}))}function getTrackIdFromSpotifyUrl(e){return e.substring(e.lastIndexOf("/")+1,e.indexOf("?"))}function run(e,t){var o=new File(Folder.temp.fsName+"/temp.bat");o.open("w"),t?(o.writeln("@echo off"),o.writeln(e),o.writeln("@pause")):o.writeln(e),o.close(),o.execute()}function resizeCode(e,t){var o=app.activeDocument,r=app.activeDocument.activeLayer.pathItems;r.length>0&&r[r.length-1].remove();var a=o.layers.getByName("Layer 1"),i=[],n=[];function s(e){if("PathItem"==e.typename)i.push(e);else if("CompoundPathItem"==e.typename)n.push(e);else if("GroupItem"==e.typename)for(var t=0;t<e.pageItems.length;t++)s(e.pageItems[t])}for(var p=0;p<a.pageItems.length;p++)s(a.pageItems[p]);var l=a.groupItems.add();for(p=0;p<i.length;p++)i[p].moveToBeginning(l);for(p=0;p<n.length;p++)n[p].moveToBeginning(l);l.width=e/25.4*72,l.height=t/25.4*72;for(p=0;p<l.pageItems.length;p++){var d=l.pageItems[p];if("PathItem"==d.typename)(m=new SpotColor).spot=app.activeDocument.spots.getByName("Spot1"),d.fillColor=m;else if("CompoundPathItem"==d.typename)for(var c=0;c<d.pathItems.length;c++){var m,f=d.pathItems[c];(m=new SpotColor).spot=app.activeDocument.spots.getByName("Spot1"),f.fillColor=m}}codeUUID=create_UUID(),l.name=codeUUID}function findGroup(e){for(var t=app.activeDocument.groupItems,o=0;o<t.length;o++){var r=t[o];if(r.name==e){r.selected=!0;break}}}function fillInfo(e){var t=Folder.desktop+"/spotify/"+e+"/data.json",o=new File(t);o.open("r");var r=o.read();o.close();var a=JSON.parse(r);artistName=a.creator,songName=a.title}function setNamesAndMove(e,t){for(var o=e.name,r=app.activeDocument,a=0;a<r.artboards.length;a++){r.artboards.setActiveArtboardIndex(a);for(var i=0;i<r.groupItems.length;i++){if((g=r.groupItems[i]).name===o)for(var n=0;n<g.textFrames.length;n++){-1!==(s=g.textFrames[n]).contents.indexOf("Song Name")&&(s.contents=songName)}}}for(a=0;a<r.artboards.length;a++){r.artboards.setActiveArtboardIndex(a);for(i=0;i<r.groupItems.length;i++){if((g=r.groupItems[i]).name===o)for(n=0;n<g.textFrames.length;n++){var s;-1!==(s=g.textFrames[n]).contents.indexOf("Artist Name")&&(s.contents=artistName)}}}e.transform(app.getScaleMatrix(-100,100));var p=!1;for(a=0;a<r.layers.length;a++)if("Artwork"==r.layers[a].name){p=!0;break}if(!p){(u=r.layers.add()).name="Artwork",e.move(u,ElementPlacement.PLACEATEND);var l=2.8346*10,d=(h=r.artboards[0]).artboardRect,c=d[0]+l,m=d[1]-l;e.position=[c,m]}if(p){var f,u=r.layers.getByName("Artwork");for(a=0;a<u.groupItems.length;a++){var g=u.groupItems[a];(!f||g.position[1]>f.position[1])&&(f=g)}e.move(u,ElementPlacement.PLACEATEND);var v=f.top-e.top;e.top+=v;l=2.8346*10;var h=r.artboards[0],y=u.groupItems,w=(l=2.8346*10,h.artboardRect[0]+l),x=h.artboardRect[1]-l;for(a=0;a<y.length;a++){w+(g=y[a]).width>h.artboardRect[2]&&(w=h.artboardRect[0]+l,x+=g.height-2*g.height-l),g.left=w,g.top=x,w+=g.width+l}}}function pushToList(e){try{var t=new File(Folder.desktop+"/photoNames.json");t.open("r");var o=t.read();t.close()}catch(e){alert("An error occurred while opening the file: "+e)}try{uuidList=JSON.parse(o)}catch(e){uuidList=[]}uuidList.push(e+".png");try{t.open("w"),t.write(JSON.stringify(uuidList)),t.close()}catch(e){alert("An error occurred while writing to the file: "+e)}}main(),spotifyCode(),createSpotColor(),spotifyCodeSize();